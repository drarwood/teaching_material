<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Prof.&nbsp;Andrew R Wood">
<meta name="dcterms.date" content="2026-01-19">

<title>HPDM098 Stratified Medicine Workshop 4: Analysis of Continuous Primary Care Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="hdpm098_workshop3_files/libs/clipboard/clipboard.min.js"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/popper.min.js"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="hdpm098_workshop3_files/libs/quarto-html/anchor.min.js"></script>
<link href="hdpm098_workshop3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="hdpm098_workshop3_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="hdpm098_workshop3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="hdpm098_workshop3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="hdpm098_workshop3_files/libs/bootstrap/bootstrap-d5214d16172734abcd1dcccc621ce81b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">HPDM098 Stratified Medicine Workshop 4: Analysis of Continuous Primary Care Data</h1>
            <p class="subtitle lead">MSc Health Data Science, University of Exeter</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Prof.&nbsp;Andrew R Wood <a href="mailto:A.R.Wood@exeter.ac.uk" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">2026-01-19</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#aims-of-workshop" id="toc-aims-of-workshop" class="nav-link" data-scroll-target="#aims-of-workshop"><span class="header-section-number">2</span> Aims of workshop</a></li>
  <li><a href="#conda-environment" id="toc-conda-environment" class="nav-link" data-scroll-target="#conda-environment"><span class="header-section-number">3</span> Conda environment</a></li>
  <li><a href="#workshop-directory" id="toc-workshop-directory" class="nav-link" data-scroll-target="#workshop-directory"><span class="header-section-number">4</span> Workshop directory</a></li>
  <li><a href="#workshop-data" id="toc-workshop-data" class="nav-link" data-scroll-target="#workshop-data"><span class="header-section-number">5</span> Workshop data</a></li>
  <li><a href="#load-required-r-libraries-for-workshop" id="toc-load-required-r-libraries-for-workshop" class="nav-link" data-scroll-target="#load-required-r-libraries-for-workshop"><span class="header-section-number">6</span> Load required R libraries for workshop</a></li>
  <li><a href="#activity-1-data-wrangling" id="toc-activity-1-data-wrangling" class="nav-link" data-scroll-target="#activity-1-data-wrangling"><span class="header-section-number">7</span> Activity 1: Data Wrangling</a>
  <ul class="collapse">
  <li><a href="#load-in-the-data" id="toc-load-in-the-data" class="nav-link" data-scroll-target="#load-in-the-data"><span class="header-section-number">7.1</span> Load in the data</a></li>
  <li><a href="#remove-records-missing-a-date-none-or-numeric-value" id="toc-remove-records-missing-a-date-none-or-numeric-value" class="nav-link" data-scroll-target="#remove-records-missing-a-date-none-or-numeric-value"><span class="header-section-number">7.2</span> Remove records missing a date (=“None”) or numeric value</a></li>
  <li><a href="#keep-records-with-only-one-numeric-value" id="toc-keep-records-with-only-one-numeric-value" class="nav-link" data-scroll-target="#keep-records-with-only-one-numeric-value"><span class="header-section-number">7.3</span> Keep records with only one numeric value</a>
  <ul class="collapse">
  <li><a href="#question" id="toc-question" class="nav-link" data-scroll-target="#question"><span class="header-section-number">7.3.1</span> Question</a></li>
  </ul></li>
  <li><a href="#resolve-muliple-weight-records-on-same-date" id="toc-resolve-muliple-weight-records-on-same-date" class="nav-link" data-scroll-target="#resolve-muliple-weight-records-on-same-date"><span class="header-section-number">7.4</span> Resolve muliple weight records on same date</a></li>
  <li><a href="#question-1" id="toc-question-1" class="nav-link" data-scroll-target="#question-1"><span class="header-section-number">7.5</span> Question</a></li>
  </ul></li>
  <li><a href="#activity-2-quality-control" id="toc-activity-2-quality-control" class="nav-link" data-scroll-target="#activity-2-quality-control"><span class="header-section-number">8</span> Activity 2: Quality Control</a>
  <ul class="collapse">
  <li><a href="#visualising-the-data" id="toc-visualising-the-data" class="nav-link" data-scroll-target="#visualising-the-data"><span class="header-section-number">8.1</span> Visualising the data</a></li>
  <li><a href="#summarizing-the-data" id="toc-summarizing-the-data" class="nav-link" data-scroll-target="#summarizing-the-data"><span class="header-section-number">8.2</span> Summarizing the data</a></li>
  <li><a href="#using-additional-variables-to-assist-qc-of-weight" id="toc-using-additional-variables-to-assist-qc-of-weight" class="nav-link" data-scroll-target="#using-additional-variables-to-assist-qc-of-weight"><span class="header-section-number">8.3</span> Using additional variables to assist QC of weight</a></li>
  <li><a href="#removing-outlier-values-in-the-remaining-weight-data" id="toc-removing-outlier-values-in-the-remaining-weight-data" class="nav-link" data-scroll-target="#removing-outlier-values-in-the-remaining-weight-data"><span class="header-section-number">8.4</span> Removing outlier values in the remaining weight data</a>
  <ul class="collapse">
  <li><a href="#parametric-approaches-to-removing-extremeoutlying-data-points" id="toc-parametric-approaches-to-removing-extremeoutlying-data-points" class="nav-link" data-scroll-target="#parametric-approaches-to-removing-extremeoutlying-data-points"><span class="header-section-number">8.4.1</span> Parametric approaches to removing extreme/outlying data points</a></li>
  <li><a href="#non-parametric-approaches-to-outlying-data-points" id="toc-non-parametric-approaches-to-outlying-data-points" class="nav-link" data-scroll-target="#non-parametric-approaches-to-outlying-data-points"><span class="header-section-number">8.4.2</span> Non-parametric approaches to outlying data points</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">8.4.3</span> Questions</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#activity-3-deriving-measures-of-weight-change" id="toc-activity-3-deriving-measures-of-weight-change" class="nav-link" data-scroll-target="#activity-3-deriving-measures-of-weight-change"><span class="header-section-number">9</span> Activity 3: Deriving measures of weight change</a>
  <ul class="collapse">
  <li><a href="#remove-individuals-with-3-values-from-the-data-frame" id="toc-remove-individuals-with-3-values-from-the-data-frame" class="nav-link" data-scroll-target="#remove-individuals-with-3-values-from-the-data-frame"><span class="header-section-number">9.1</span> Remove individuals with &lt;3 values from the data frame</a></li>
  <li><a href="#generate-measures-of-weight-variability" id="toc-generate-measures-of-weight-variability" class="nav-link" data-scroll-target="#generate-measures-of-weight-variability"><span class="header-section-number">9.2</span> Generate measures of weight variability</a></li>
  <li><a href="#question-2" id="toc-question-2" class="nav-link" data-scroll-target="#question-2"><span class="header-section-number">9.3</span> Question</a></li>
  </ul></li>
  <li><a href="#activity-4-testing-for-an-association-between-weight-change-and-type-2-diabetes-risk" id="toc-activity-4-testing-for-an-association-between-weight-change-and-type-2-diabetes-risk" class="nav-link" data-scroll-target="#activity-4-testing-for-an-association-between-weight-change-and-type-2-diabetes-risk"><span class="header-section-number">10</span> Activity 4: Testing for an association between weight change and type 2 diabetes risk</a>
  <ul class="collapse">
  <li><a href="#questions-1" id="toc-questions-1" class="nav-link" data-scroll-target="#questions-1"><span class="header-section-number">10.1</span> Questions</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>In this workshop, you will use primary care (GP) data to obtain quantitative measures of a health-related outcome for further analysis.</p>
</section>
<section id="aims-of-workshop" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Aims of workshop</h1>
<ul>
<li>practice data wrangling</li>
<li>quality control quantitative health-related variables captured through primary care (weight)</li>
<li>formulate variables associated with longitudinal data for analysis</li>
<li>test derived measures of weight fluctuation against disease status</li>
<li>consider biases in the data and analyses performed</li>
</ul>
</section>
<section id="conda-environment" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Conda environment</h1>
<p>Before attempting this workshop, you should activate the <code>hpdm098</code> conda environment that will provide the R through Jupyter Lab and required library dependencies:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate hpdm098</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="workshop-directory" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Workshop directory</h1>
<p>All relevant files associated with this workshops can be found in the following directory:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/ubuntu/hpdm098/workshops/gp_records_w2/</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>You should navigate to this directory prior to starting the workshop. Note, a jupyter notebook can be be loaded from this directory to assist you in undertaking this workshop:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gp_records_w2.ipynb</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="workshop-data" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Workshop data</h1>
<p>The data for this workshop containing data on 1,000 individuals has been provided in a form that represents that available in UK Biobank (but is NOT UK Biobank data). The file can be found here:</p>
<p><code>/home/ubuntu/hpdm098/workshops/gp_records_w2/weight_primary_care.txt</code></p>
<p>Within the dataset you will find the following variables:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 78%">
</colgroup>
<thead>
<tr class="header">
<th>Field Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>Unique study participant ID</td>
</tr>
<tr class="even">
<td><code>provider</code></td>
<td><code>1</code>:England(Vision), <code>2</code>:Scotland, <code>3</code>:England(TPP), <code>4</code>:Wales</td>
</tr>
<tr class="odd">
<td><code>date</code></td>
<td>Date of record</td>
</tr>
<tr class="even">
<td><code>read_2</code></td>
<td>Read code (version 2) that maps to clinical terms</td>
</tr>
<tr class="odd">
<td><code>read_3</code></td>
<td>Read code (version 3) that maps to clinical terms</td>
</tr>
<tr class="even">
<td><code>val1</code></td>
<td>Value associated with record</td>
</tr>
<tr class="odd">
<td><code>val2</code></td>
<td>Value associated with record</td>
</tr>
<tr class="even">
<td><code>val3</code></td>
<td>Value associated with record</td>
</tr>
</tbody>
</table>
<p><br> In this workshop, we will be focussing on weight (kg) for which the <code>read_v2</code> code and <code>read_v3</code> code is <code>22A..</code></p>
</section>
<section id="load-required-r-libraries-for-workshop" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Load required R libraries for workshop</h1>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(ggplot2))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(gridExtra))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(stringr))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(dplyr))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="activity-1-data-wrangling" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Activity 1: Data Wrangling</h1>
<p>Your first task is to create a simplified tab-delimited file (with header) that looks like this:</p>
<table class="table-striped table-hover caption-top table">
<caption>Data format to generate</caption>
<thead>
<tr class="header">
<th>id</th>
<th>date</th>
<th>weight_kg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2000-09-21</td>
<td>89.09</td>
</tr>
<tr class="even">
<td>1</td>
<td>2004-03-11</td>
<td>104.00</td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>We will create some some that will format the data and remove problematic records</p>
<section id="load-in-the-data" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="load-in-the-data"><span class="header-section-number">7.1</span> Load in the data</h2>
<p>Read in the data into a data frame called <code>gp_data</code>.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gp_data <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">"weight_primary_care.txt"</span>, <span class="at">header=</span>T, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">stringsAsFactors =</span> F, <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">"NA"</span>, <span class="st">""</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># preview data frame</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id provider       date read_2 read_3   val1 val2 val3
1  1        3 2000-09-21   &lt;NA&gt;  22A..  89.09   NA &lt;NA&gt;
2  1        3 2004-03-11   &lt;NA&gt;  22A.. 104.00   NA &lt;NA&gt;
3  1        3 2005-02-21   &lt;NA&gt;  22A..  73.18   NA &lt;NA&gt;
4  1        3 2005-04-18   &lt;NA&gt;  22A..  88.00   NA &lt;NA&gt;
5  1        3 2005-10-17   &lt;NA&gt;  22A..  88.00   NA &lt;NA&gt;
6  1        3 2006-08-01   &lt;NA&gt;  22A..  95.00   NA &lt;NA&gt;</code></pre>
</div>
</details>
</div>
</section>
<section id="remove-records-missing-a-date-none-or-numeric-value" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="remove-records-missing-a-date-none-or-numeric-value"><span class="header-section-number">7.2</span> Remove records missing a date (=“None”) or numeric value</h2>
<p>We will later want to sort each individual by their date when deriving measures of variability so we should only consider records with a date.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use subset() function to remove records without a date</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gp_data <span class="ot">=</span> <span class="fu">subset</span>(gp_data, date <span class="sc">!=</span> <span class="st">"None"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># change column class type for date</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>gp_data<span class="sc">$</span>date <span class="ot">=</span> <span class="fu">as.Date</span>(gp_data<span class="sc">$</span>date)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># preview data frame</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id provider       date read_2 read_3   val1 val2 val3
1  1        3 2000-09-21   &lt;NA&gt;  22A..  89.09   NA &lt;NA&gt;
2  1        3 2004-03-11   &lt;NA&gt;  22A.. 104.00   NA &lt;NA&gt;
3  1        3 2005-02-21   &lt;NA&gt;  22A..  73.18   NA &lt;NA&gt;
4  1        3 2005-04-18   &lt;NA&gt;  22A..  88.00   NA &lt;NA&gt;
5  1        3 2005-10-17   &lt;NA&gt;  22A..  88.00   NA &lt;NA&gt;
6  1        3 2006-08-01   &lt;NA&gt;  22A..  95.00   NA &lt;NA&gt;</code></pre>
</div>
</details>
</div>
</section>
<section id="keep-records-with-only-one-numeric-value" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="keep-records-with-only-one-numeric-value"><span class="header-section-number">7.3</span> Keep records with only one numeric value</h2>
<p>In the data you have been provided, some records contain more than one numerical value across the variables <code>val1</code>, <code>val2</code> and <code>val3</code>. However, some of these variables also contain non-numeric values on some rows. we can not be sure the reasons why this has occurred in the data set. Therefore, we are going to filter the data to keep records with only one numerical value.</p>
<p>We will first ensure the 3 columns <code>val1</code>, <code>val2</code> and <code>val3</code> are character class to make the next steps easier as all columns will be of the same data type and functions applied will not be problematic if expecting the columns to be all be of character type.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gp_data<span class="sc">$</span>val1 <span class="ot">=</span> <span class="fu">as.character</span>(gp_data<span class="sc">$</span>val1)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>gp_data<span class="sc">$</span>val2 <span class="ot">=</span> <span class="fu">as.character</span>(gp_data<span class="sc">$</span>val2)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>gp_data<span class="sc">$</span>val3 <span class="ot">=</span> <span class="fu">as.character</span>(gp_data<span class="sc">$</span>val3)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We will now create a data frame frame called <code>gp_data_filtered</code> to hold all records with one numerical value &gt;0.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use dplyr to do this, applying filter to each row of the gp_records data frame</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>gp_data_filtered <span class="ot">=</span> gp_data <span class="sc">|&gt;</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># by row:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply the filter function:</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>({</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to numerical values</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">c_across</span>(<span class="fu">c</span>(val1, val2, val3)))) </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count how many numeric values are &gt; 0</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(vals <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># applying the ungroup() function is good practice to remove any grouping of data</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview data frame containing rows with one numerical value &gt;0</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_data_filtered,<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 8
      id provider date       read_2 read_3 val1  val2  val3 
   &lt;int&gt;    &lt;int&gt; &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1     1        3 2000-09-21 &lt;NA&gt;   22A..  89.09 &lt;NA&gt;  &lt;NA&gt; 
 2     1        3 2004-03-11 &lt;NA&gt;   22A..  104   &lt;NA&gt;  &lt;NA&gt; 
 3     1        3 2005-02-21 &lt;NA&gt;   22A..  73.18 &lt;NA&gt;  &lt;NA&gt; 
 4     1        3 2005-04-18 &lt;NA&gt;   22A..  88    &lt;NA&gt;  &lt;NA&gt; 
 5     1        3 2005-10-17 &lt;NA&gt;   22A..  88    &lt;NA&gt;  &lt;NA&gt; 
 6     1        3 2006-08-01 &lt;NA&gt;   22A..  95    &lt;NA&gt;  &lt;NA&gt; 
 7     1        3 2006-08-09 &lt;NA&gt;   22A..  95    &lt;NA&gt;  &lt;NA&gt; 
 8     1        3 2006-11-03 &lt;NA&gt;   22A..  100   &lt;NA&gt;  &lt;NA&gt; 
 9     1        3 2007-02-27 &lt;NA&gt;   22A..  100   &lt;NA&gt;  &lt;NA&gt; 
10     1        3 2007-11-05 &lt;NA&gt;   22A..  100   &lt;NA&gt;  &lt;NA&gt; </code></pre>
</div>
</details>
</div>
<p>Finally, let’s format the data so numerical values are in one column instead of being help in either <code>var1</code>, <code>var2</code> or <code>var3</code> fields of the <code>gp_data_filtered</code> data frame. We will first convert the character fields to numeric so that any non-numeric values become <code>NA</code>. We will then use the <code>coalesce()</code> function which finds the first non-missing (numerical) value across the 3 fields. The <code>mutate()</code> function will allow us to create a new variable called <code>weight</code> in the data frame to store the value returned by the <code>coalesce()</code> function.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert columns of val1, val2, val3 to numeric. Any non numerical values will be replaced with NA</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gp_data_filtered<span class="sc">$</span>val1 <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(gp_data_filtered<span class="sc">$</span>val1))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>gp_data_filtered<span class="sc">$</span>val2 <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(gp_data_filtered<span class="sc">$</span>val2))</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>gp_data_filtered<span class="sc">$</span>val3 <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(gp_data_filtered<span class="sc">$</span>val3))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a column that contains the numerical value from across the 3 variables</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We will use the coalesce function to find the first non-missing value across the variables</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>gp_data_filtered <span class="ot">=</span> gp_data_filtered <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">coalesce</span>(val1, val2, val3))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview the data frame</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_data_filtered)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
     id provider date       read_2 read_3  val1  val2  val3 weight
  &lt;int&gt;    &lt;int&gt; &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1        3 2000-09-21 &lt;NA&gt;   22A..   89.1    NA    NA   89.1
2     1        3 2004-03-11 &lt;NA&gt;   22A..  104      NA    NA  104  
3     1        3 2005-02-21 &lt;NA&gt;   22A..   73.2    NA    NA   73.2
4     1        3 2005-04-18 &lt;NA&gt;   22A..   88      NA    NA   88  
5     1        3 2005-10-17 &lt;NA&gt;   22A..   88      NA    NA   88  
6     1        3 2006-08-01 &lt;NA&gt;   22A..   95      NA    NA   95  </code></pre>
</div>
</details>
</div>
<p>It’s a good idea to check rows that we have now excluded. Let’s also check the behavior of the logic above is as expected for removing individuals by creating a data frame called <code>gp_data_excluded</code> to hold all excluded records.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gp_data_excluded <span class="ot">=</span> gp_data <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>({</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to numerical values</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">=</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(<span class="fu">c_across</span>(<span class="fu">c</span>(val1, val2, val3)))) </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count how many numeric values are &gt; 0</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(vals <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">1</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview data frame containing rows with no- or more than one numerical value &gt;0</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_data_excluded,<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 8
      id provider date       read_2 read_3 val1  val2  val3 
   &lt;int&gt;    &lt;int&gt; &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1    26        2 2005-03-17 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 2    26        2 2006-03-08 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 3    26        2 2007-02-14 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 4    26        2 2008-03-12 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 5    26        2 2008-04-21 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 6    26        2 2009-04-15 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 7    26        2 2010-06-16 22A..  &lt;NA&gt;   &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
 8    27        3 2014-04-28 &lt;NA&gt;   22A..  0     &lt;NA&gt;  &lt;NA&gt; 
 9    32        2 2002-12-11 22A..  &lt;NA&gt;   76    &lt;NA&gt;  27.2 
10    32        2 2004-02-05 22A..  &lt;NA&gt;   77    &lt;NA&gt;  26.6 </code></pre>
</div>
</details>
</div>
<section id="question" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="question"><span class="header-section-number">7.3.1</span> Question</h3>
<ul>
<li>Can you think of reasons why there may be more than one numerical weight value for some of records that were excluded?</li>
</ul>
</section>
</section>
<section id="resolve-muliple-weight-records-on-same-date" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="resolve-muliple-weight-records-on-same-date"><span class="header-section-number">7.4</span> Resolve muliple weight records on same date</h2>
<p>Multiple records associated with same read codes with assigned numerical values may appear on the same date. Values may be duplicated across such records or they may differ. We therefore need to resolve this.</p>
<p>A quick look at just one individual (<code>id</code>=<code>500</code>) shows that some records occur on the same date as others.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">subset</span>(gp_data_filtered, id<span class="sc">==</span><span class="dv">500</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
     id provider date       read_2 read_3  val1  val2  val3 weight
  &lt;int&gt;    &lt;int&gt; &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1   500        2 2000-06-20 22A..  &lt;NA&gt;    105.    NA    NA   105.
2   500        2 2001-02-20 22A..  &lt;NA&gt;     95     NA    NA    95 
3   500        2 2001-02-20 22A..  &lt;NA&gt;     95     NA    NA    95 
4   500        2 2001-02-20 22A..  &lt;NA&gt;     95     NA    NA    95 
5   500        2 2001-02-20 22A..  &lt;NA&gt;     95     NA    NA    95 
6   500        2 2001-02-20 22A..  &lt;NA&gt;     95     NA    NA    95 </code></pre>
</div>
</details>
</div>
<p>We therefore need a strategy should we employ to resolve multiple records for the same variable on the same date. The approach we will take is to calculate the range (maximum value - minimum value) of numerical values assigned to weight on a given date and average the values if range &lt; 2. Otherwise, remove records associated with the date.</p>
<p>We will create a new data frame called <code>weight_data</code> as an updated version of the <code>gp_data_filtered</code> data frame so we can compare before and after applying the logic.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>weight_data <span class="ot">=</span> gp_data_filtered <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id, date) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">weight_range =</span> <span class="fu">max</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">min</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_weight =</span> <span class="fu">mean</span>(weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only groups where the range &lt; 2</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(weight_range <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only the columns you need</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, date, <span class="at">weight =</span> avg_weight)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview weight_data data frame</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weight_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
     id date       weight
  &lt;int&gt; &lt;date&gt;      &lt;dbl&gt;
1     1 2000-09-21   89.1
2     1 2004-03-11  104  
3     1 2005-02-21   73.2
4     1 2005-04-18   88  
5     1 2005-10-17   88  
6     1 2006-08-01   95  </code></pre>
</div>
</details>
</div>
<p>We can look at specific examples to show that his has done what we have wanted.<br>
Look at sample with id <code>96</code> and date <code>2013-02-21</code></p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="fu">subset</span>(gp_data_filtered, id<span class="sc">==</span><span class="dv">96</span> <span class="sc">&amp;</span> date<span class="sc">==</span><span class="st">"2013-02-21"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id provider       date read_2 read_3 val1 val2 val3 weight
1 96        3 2013-02-21   &lt;NA&gt;  22A..  102   NA   NA    102
2 96        3 2013-02-21   &lt;NA&gt;  22A..  103   NA   NA    103</code></pre>
</div>
</details>
</div>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="fu">subset</span>(weight_data, id<span class="sc">==</span><span class="dv">96</span> <span class="sc">&amp;</span> date<span class="sc">==</span><span class="st">"2013-02-21"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id       date weight
1 96 2013-02-21  102.5</code></pre>
</div>
</details>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rows removed from final data frame</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Check we have removed records we would expect as outside of range.<br>
Look at sample with id <code>38</code> and date <code>2007-06-27</code></p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="fu">subset</span>(gp_data_filtered, id<span class="sc">==</span><span class="dv">38</span> <span class="sc">&amp;</span> date<span class="sc">==</span><span class="st">"2007-06-27"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id provider       date read_2 read_3 val1 val2 val3 weight
1 38        3 2007-06-27   &lt;NA&gt;  22A..  106   NA   NA    106
2 38        3 2007-06-27   &lt;NA&gt;  22A..  126   NA   NA    126</code></pre>
</div>
</details>
</div>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="fu">subset</span>(weight_data, id<span class="sc">==</span><span class="dv">38</span> <span class="sc">&amp;</span> date<span class="sc">==</span><span class="st">"2007-06-27"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>[1] id     date   weight
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
</div>
</details>
</div>
</section>
<section id="question-1" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="question-1"><span class="header-section-number">7.5</span> Question</h2>
<ul>
<li>Do you have any suggestions as to how this strategy could be improved?</li>
</ul>
<hr>
</section>
</section>
<section id="activity-2-quality-control" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Activity 2: Quality Control</h1>
<p>Although we have generated the <code>weight_data</code> data frame from the primary care records, we still need to check whether the values for weight (kg) make sense. Even though this data is supposed to come from GP practices, mistakes are made on data entry.</p>
<section id="visualising-the-data" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="visualising-the-data"><span class="header-section-number">8.1</span> Visualising the data</h2>
<p>A helpful starting point is to visually examine the distribution of weight and check the values lie within ranges we would expect. If you are unsure what range to expect, it can be useful to use a reference data set to get an idea. For example, we could look at the distribution of weight measured in a reference dataset such as UK Biobank using their data showcase which provides the observed distribution of weight (kg) <a href="https://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=21002">here</a>. We can use this to get an idea of what we might expect assuming individuals in the reference data set are representative of the individuals in our study. For example, based on UK Biobank, we wouldn’t necessarily expect an adult in our data set to have weight measure of 10kg or be more than 200kg.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight)) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Weight Values from Primary Care Data"</span>, <span class="at">x =</span> <span class="st">"Weight (KG)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>weight)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of Weight Values from Primary Care Data"</span>, <span class="at">y =</span> <span class="st">"Weight (KG)"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,<span class="at">ncol=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These plots immediately indicate that we have some extreme outlying values that we need to remove.</p>
</section>
<section id="summarizing-the-data" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="summarizing-the-data"><span class="header-section-number">8.2</span> Summarizing the data</h2>
<p>Next we can summarize the data numerically</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_weight   =</span> <span class="fu">mean</span>(weight,   <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_weight     =</span> <span class="fu">sd</span>(weight,     <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_weight    =</span> <span class="fu">min</span>(weight,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight    =</span> <span class="fu">max</span>(weight,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_weight =</span> <span class="fu">median</span>(weight, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  mean_weight sd_weight min_weight max_weight median_weight
        &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;
1        83.5      25.6       1.05       394.          82.7</code></pre>
</div>
</details>
</div>
</section>
<section id="using-additional-variables-to-assist-qc-of-weight" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="using-additional-variables-to-assist-qc-of-weight"><span class="header-section-number">8.3</span> Using additional variables to assist QC of weight</h2>
<p>You may have already considered that one reason why values &lt;50 for weight exist could be because BMI has been entered instead of weight and assigned to the read-code for weight (<code>22A..</code>) instead of being assigned the read-code <code>22k..</code> for BMI. Data entry errors do occur and so we should check whether this is a potential cause.</p>
<p>We will load in data on height, calculate the BMIs, and compare against a reference distribution. We will then filter weight values based on the respective calculated BMI. Again, we will use the <a href="https://biobank.ctsu.ox.ac.uk/ukb/field.cgi?id=21001">UK Biobank showcase</a> to obtain an distribution of BMI from a subset of the general population of the UK. Based on this distribution, we will keep weight values if the corresponding BMI value is 15 &lt; BMI &lt; 50. Although there may be some real BMI values outside of this range, they will be extreme outliers. For the purposes of this analysis we will exclude weights associated with extreme BMI which we will subsequently define below.</p>
<p>The formula for BMI is:</p>
<center>
<span class="math display">\[bmi = \frac{weight (kg)}{height (m)^{2}}\]</span>
</center>
<p><br></p>
<p>In the workshop data provided, we have measures of height (cm) from which we can calculate BMI. You may assume the height data has already been QC’d.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load in the height data</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>height_data <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">"height.txt"</span>, <span class="at">header=</span>T, <span class="at">stringsAsFactors =</span> F, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge to the weight_data DF</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>weight_data <span class="ot">=</span> <span class="fu">merge</span>(weight_data, height_data, <span class="at">by=</span><span class="st">"id"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Calculate BMI, remembering that height is in centimeters and BMI uses meters squared as the denominator:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>weight_data<span class="sc">$</span>bmi <span class="ot">=</span> weight_data<span class="sc">$</span>weight <span class="sc">/</span> (weight_data<span class="sc">$</span>height_cm <span class="sc">/</span> <span class="dv">100</span>)<span class="sc">^</span><span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lets first examine the distribution of BMI</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>weight_data  <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bmi)) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of BMI Values"</span>, <span class="at">x =</span> <span class="st">"BMI"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>weight_data  <span class="sc">|&gt;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>bmi)) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of BMI Values"</span>, <span class="at">x=</span><span class="st">""</span>, <span class="at">y =</span> <span class="st">"BMI"</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>weight, <span class="at">y=</span>bmi)) <span class="sc">+</span> </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weight against calculated BMI"</span>, <span class="at">x=</span><span class="st">"Weight"</span>, <span class="at">y =</span> <span class="st">"BMI"</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3,<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s keep weight values where 15 &lt; BMI &lt; 50</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>weight_data<span class="sc">$</span>weight_qc1 <span class="ot">=</span> <span class="fu">ifelse</span>(weight_data<span class="sc">$</span>bmi <span class="sc">&lt;</span> <span class="dv">15</span> <span class="sc">|</span> weight_data<span class="sc">$</span>bmi <span class="sc">&gt;</span> <span class="dv">50</span>, <span class="cn">NA</span>, weight_data<span class="sc">$</span>weight)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s check our weight distribution again</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight)) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Hist. of weight values"</span>, <span class="at">x =</span> <span class="st">"Weight (KG)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc1)) <span class="sc">|&gt;</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_qc1)) <span class="sc">+</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Hist. of QC'd weight values"</span>, <span class="at">x =</span> <span class="st">"Weight (KG)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> </span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>weight)) <span class="sc">+</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of weight values"</span>, <span class="at">y =</span> <span class="st">"Weight (KG)"</span>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">=</span> </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc1)) <span class="sc">|&gt;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>weight_qc1)) <span class="sc">+</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of QC'd weight values"</span>, <span class="at">y =</span> <span class="st">"Weight (KG)"</span>)</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">=</span> </span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>weight, <span class="at">y=</span>bmi)) <span class="sc">+</span> </span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weight against BMI"</span>, <span class="at">x=</span><span class="st">"Weight"</span>, <span class="at">y =</span> <span class="st">"BMI"</span>)</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">=</span> </span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc1)) <span class="sc">|&gt;</span></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>weight_qc1, <span class="at">y=</span>bmi)) <span class="sc">+</span> </span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QC'd Weight against BMI"</span>, <span class="at">x=</span><span class="st">"Weight"</span>, <span class="at">y =</span> <span class="st">"BMI"</span>)</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p3,p4,<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p5,p6,<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-24-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s check the numerical summary for weight again</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_weight   =</span> <span class="fu">mean</span>(weight_qc1,   <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_weight     =</span> <span class="fu">sd</span>(weight_qc1,     <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_weight    =</span> <span class="fu">min</span>(weight_qc1,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight    =</span> <span class="fu">max</span>(weight_qc1,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_weight =</span> <span class="fu">median</span>(weight_qc1, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  mean_weight sd_weight min_weight max_weight median_weight
1    84.48181  21.06999         32      158.3            83</code></pre>
</div>
</details>
</div>
<p>We can see that the distribution of values for weight no longer contains extreme values, with lower extreme values most likely caused by entries for BMI being incorrectly entered.</p>
<p>At this point we could accept the values that remain for subsequent analysis or we could perform additional QC - for example, a minimum value or 32 may seem unlikely but could be real. Ultimately, this decision, like others, are subjective that we hope lead to a sensible distribution - there is not a single “right” answer.</p>
</section>
<section id="removing-outlier-values-in-the-remaining-weight-data" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="removing-outlier-values-in-the-remaining-weight-data"><span class="header-section-number">8.4</span> Removing outlier values in the remaining weight data</h2>
<p>There are a number of ways in which we could remove outliers depending on the shape of the expected distribution of the variable. Arguably, there are two common approaches that are used for removing outliers from a distribution based on the distribution itself: <strong>parametric</strong> and <strong>non-parametric</strong> approaches.</p>
<section id="parametric-approaches-to-removing-extremeoutlying-data-points" class="level3" data-number="8.4.1">
<h3 data-number="8.4.1" class="anchored" data-anchor-id="parametric-approaches-to-removing-extremeoutlying-data-points"><span class="header-section-number">8.4.1</span> Parametric approaches to removing extreme/outlying data points</h3>
<p>Parametric approaches assume we know something about the underlying distibution of the data and the parameters associated with the distribution. For example, we may note that the data follows a <strong>normal distribution</strong> (otherwise known as <strong>Gaussan distribution</strong>) for which the parameters will include the <strong>mean</strong> and <strong>standard deviation (SD)</strong> and the data symmetrically distributed around the mean.</p>
<p>We could argue that most of the QC’d weight distribution looks “normal” with exception of some outlying values - so we may use a “parametric” approach to remove those outlying values. A common approach is to calculate the number of standard deviations from the mean a data point lies and remove data points further away than a set threshold. Common SD thresholds include <strong>&gt;|3|</strong> or <strong>&gt;|4|</strong> SDs. This choice is somewhat arbitary and depends on how inclusive we want to be.</p>
<p>Note, the number of SDs a data point is away from the mean is referred to as it’s <strong>z-score</strong>. We can obtain the z-scores of a variable by using the <code>scale()</code> function in R. So, if we wanted to create a variable that removed weight values greater than 3 SDs either side of the mean, we could run the following code:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>weight_data<span class="sc">$</span>weight_qc2 <span class="ot">=</span> <span class="fu">ifelse</span>( <span class="fu">as.numeric</span>(<span class="fu">scale</span>(weight_data<span class="sc">$</span>weight_qc1)) <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">|</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(weight_data<span class="sc">$</span>weight_qc1)) <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="cn">NA</span>, weight_data<span class="sc">$</span>weight_qc1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We could then plot the distributions again and regenerate the numerical summary to check:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc2)) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_qc2)) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Weight Values from Primary Care Data"</span>, <span class="at">x =</span> <span class="st">"Weight (KG)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc2)) <span class="sc">|&gt;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>weight_qc2)) <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of Weight Values from Primary Care Data"</span>, <span class="at">y =</span> <span class="st">"Weight (KG)"</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,<span class="at">ncol=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_weight   =</span> <span class="fu">mean</span>(weight_qc2,   <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_weight     =</span> <span class="fu">sd</span>(weight_qc2,     <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_weight    =</span> <span class="fu">min</span>(weight_qc2,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight    =</span> <span class="fu">max</span>(weight_qc2,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_weight =</span> <span class="fu">median</span>(weight_qc2, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  mean_weight sd_weight min_weight max_weight median_weight
1    84.34975  20.87789         32        147            83</code></pre>
</div>
</details>
</div>
<p>As a result, we have taken out some data points at the higher end of the distribution but have not removed any potential outliers at the bottom of the distribution (e.g.&nbsp;weight=32kg).</p>
</section>
<section id="non-parametric-approaches-to-outlying-data-points" class="level3" data-number="8.4.2">
<h3 data-number="8.4.2" class="anchored" data-anchor-id="non-parametric-approaches-to-outlying-data-points"><span class="header-section-number">8.4.2</span> Non-parametric approaches to outlying data points</h3>
<p>Another approach we could take is to not make any real assumptions about the shape of the distribution and take a <strong>non-parametric</strong> approach. We will use the <code>median</code> (50th centile weight value) and <code>inter-quartile range</code> (75th centile weight value (Q3) - 25th centile weight value (Q1)) to define outliers and remove them. We can used the <code>IQR()</code> function to perform the calculate the inter-quartile range for us). Specifically, we will remove values if:</p>
<p><span class="math inline">\(weight &lt; median - 1.5IQR\)</span></p>
<p>or</p>
<p><span class="math inline">\(weight &gt; median + 1.5IQR\)</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>weight_data<span class="sc">$</span>weight_qc3 <span class="ot">=</span> <span class="fu">ifelse</span>( </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  weight_data<span class="sc">$</span>weight_qc1 <span class="sc">&lt;</span> <span class="fu">median</span>(weight_data<span class="sc">$</span>weight_qc1, <span class="at">na.rm =</span> T) <span class="sc">-</span> (<span class="fl">1.5</span><span class="sc">*</span><span class="fu">IQR</span>(weight_data<span class="sc">$</span>weight_qc1, <span class="at">na.rm =</span> T)) <span class="sc">|</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  weight_data<span class="sc">$</span>weight_qc1 <span class="sc">&gt;</span> <span class="fu">median</span>(weight_data<span class="sc">$</span>weight_qc1, <span class="at">na.rm =</span> T) <span class="sc">+</span> (<span class="fl">1.5</span><span class="sc">*</span><span class="fu">IQR</span>(weight_data<span class="sc">$</span>weight_qc1, <span class="at">na.rm =</span> T)),  </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span>, weight_data<span class="sc">$</span>weight_qc1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Plot the distributions and check numerical summary again:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc3)) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weight_qc3)) <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">10</span>, <span class="at">colour =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Weight Values from Primary Care Data"</span>, <span class="at">x =</span> <span class="st">"Weight (KG)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>weight_data  <span class="sc">|&gt;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc3)) <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y=</span>weight_qc3)) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Boxplot of Weight Values from Primary Care Data"</span>, <span class="at">y =</span> <span class="st">"Weight (KG)"</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,<span class="at">ncol=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hdpm098_workshop3_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>weight_data <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_weight   =</span> <span class="fu">mean</span>(weight_qc3,   <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_weight     =</span> <span class="fu">sd</span>(weight_qc3,     <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_weight    =</span> <span class="fu">min</span>(weight_qc3,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_weight    =</span> <span class="fu">max</span>(weight_qc3,    <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_weight =</span> <span class="fu">median</span>(weight_qc3, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  mean_weight sd_weight min_weight max_weight median_weight
1    83.65196  17.80868       41.7      124.3            83</code></pre>
</div>
</details>
</div>
</section>
<section id="questions" class="level3" data-number="8.4.3">
<h3 data-number="8.4.3" class="anchored" data-anchor-id="questions"><span class="header-section-number">8.4.3</span> Questions</h3>
<ul>
<li>Do you notice any differences between using a parametric and non-parametric approach?</li>
<li>Which approach would you take given the differences above and why?</li>
</ul>
<hr>
</section>
</section>
</section>
<section id="activity-3-deriving-measures-of-weight-change" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Activity 3: Deriving measures of weight change</h1>
<p>Now we have a QC’d version One health-related research question may be to look at the effects of weight change over time and how that might be associated with disease. Measures of <strong>within-individual</strong> variability commonly used in health-related research include standard deviation but also:</p>
<p><strong>Coefficient of variation per individual</strong><br>
This is the mean divided by the standard deviation of the data points. This is an alternative to using SD where the units become standardized, whereas SD values are directly related to the scale of the variable (e.g.&nbsp;kg).</p>
<p>Formula:<br>
</p>
<center>
<span class="math display">\[cov = \frac{s} {\bar{x}}\]</span>
</center>
<p>where<br>
<span class="math inline">\(s\)</span> is the standard deviation<br>
<span class="math inline">\(\bar{x}\)</span> is the mean<br>
<br></p>
<p><strong>Average successive variability per individual</strong><br>
This is the average of the absolute difference between consecutive data points over time.</p>
<p>Formula:<br>
</p>
<center>
<span class="math display">\[asv = \frac{ \sum_{i=1}^{n-1} | x_{i} - x_{i+1} | } {n-1}\]</span>
</center>
<p>where<br>
<span class="math inline">\(x_i\)</span> is a data point <span class="math inline">\(x\)</span> at time point <span class="math inline">\(i\)</span><br>
<span class="math inline">\(n\)</span> is the number of data points</p>
<section id="remove-individuals-with-3-values-from-the-data-frame" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="remove-individuals-with-3-values-from-the-data-frame"><span class="header-section-number">9.1</span> Remove individuals with &lt;3 values from the data frame</h2>
<p>We want to remove individuals with &lt;3 values at it is harder as estimates of variability among these subjects will be limited. We will use weight values in <code>weight_qc3</code> and keep remaining individuals in a data frame called <code>weight_data_3plus</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Code to remove indivduals with &lt;3 QC'd values for weight</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>weight_data_3plus <span class="ot">=</span> weight_data <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc3)) <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="generate-measures-of-weight-variability" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="generate-measures-of-weight-variability"><span class="header-section-number">9.2</span> Generate measures of weight variability</h2>
<p>We will first calculate SD, and coefficient of variation for each individual and store in a data frame called <code>weight_change_measures</code>.</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and SD per individual for subsequent use. </span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>weight_change_measures <span class="ot">=</span> weight_data_3plus <span class="sc">|&gt;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(weight_qc3)),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_weight =</span> <span class="fu">mean</span>(weight_qc3, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_weight =</span> <span class="fu">sd</span>(weight_qc3, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),   </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Coefficient of Variation</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>weight_change_measures<span class="sc">$</span>cov <span class="ot">=</span> weight_change_measures<span class="sc">$</span>sd_weight <span class="sc">/</span> weight_change_measures<span class="sc">$</span>mean_weight</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weight_change_measures)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id n_obs mean_weight sd_weight        cov
1  1    40    94.68300  7.413974 0.07830312
2  2    41    95.86854  4.069168 0.04244529
3  3    26    66.46485  2.560007 0.03851671
4  4    28   103.85300  5.342308 0.05144106
5  5    13    87.99231  3.696950 0.04201446
6  6    11    88.55109  3.920829 0.04427759</code></pre>
</div>
</details>
</div>
<p>Now we will calculate averge successive variability</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First lets check data ordered by individual ID and date:</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>weight_data_3plus <span class="ot">=</span> weight_data_3plus <span class="sc">|&gt;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we will calulate absolute changes from one date to the next, average them, count total number of record per individual, and the calculate ASV.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>asv_df <span class="ot">=</span> weight_data_3plus <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create variable called abs_weight_change. </span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use lag() - returns NA for first record of individual or if previous value for patient NA through QC</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_weight_change =</span> <span class="fu">abs</span>(weight_qc3 <span class="sc">-</span> <span class="fu">lag</span>(weight_qc3))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate mean abs_weight_change</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">asv =</span> <span class="fu">mean</span>(abs_weight_change, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Merge <code>asv_df</code> data frame to <code>weight_change_measures</code> data frame</p>
<div class="cell" data-output-fold="true" data-output-summary="View output">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>weight_change_measures <span class="ot">=</span> <span class="fu">merge</span>(weight_change_measures, asv_df, <span class="at">by=</span><span class="st">"id"</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weight_change_measures)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<details><summary>View output</summary>
<div class="cell-output cell-output-stdout">
<pre><code>  id n_obs mean_weight sd_weight        cov      asv
1  1    40    94.68300  7.413974 0.07830312 4.947436
2  2    41    95.86854  4.069168 0.04244529 1.848000
3  3    26    66.46485  2.560007 0.03851671 2.308960
4  4    28   103.85300  5.342308 0.05144106 2.252593
5  5    13    87.99231  3.696950 0.04201446 3.500000
6  6    11    88.55109  3.920829 0.04427759 2.599200</code></pre>
</div>
</details>
</div>
</section>
<section id="question-2" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="question-2"><span class="header-section-number">9.3</span> Question</h2>
<ul>
<li>What limitations do you think there are for deriving weight variability in this way?</li>
</ul>
<hr>
</section>
</section>
<section id="activity-4-testing-for-an-association-between-weight-change-and-type-2-diabetes-risk" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Activity 4: Testing for an association between weight change and type 2 diabetes risk</h1>
<p>One question we might ask is how changes in weight over time is associated with adverse health outcomes, such as disease.</p>
<p>One of the biggest risk factors for type 2 diabetes is obesity yet less is known about how fluctuation in weight over time may be associated with the disease.</p>
<p>You have been provided with a file named <code>t2d_status.txt</code>. Load this in, bind it to the data frame containing your estimate, and create a logistic model that tests for an association between your derived measures of weight variability. You should adjust for the number of observations per person as part of the model.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data in</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>t2d_status <span class="ot">=</span> <span class="fu">read.table</span>(<span class="st">"t2d_status.txt"</span>, <span class="at">stringsAsFactors =</span> F, <span class="at">header=</span>T, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge to data frame with variability measures</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># insert code here</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform logistic regression models</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># insert code here</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="questions-1" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="questions-1"><span class="header-section-number">10.1</span> Questions</h2>
<ul>
<li>Is there an association between weight variability and type 2 diabetes risk?</li>
<li>What other predictors for type 2 diabetes might we want to additionally include in the model?</li>
<li>Do you know how you might use a regression model to estimate effects of changes in predictor over time instead of deriving a variable with values that represent variability?</li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>